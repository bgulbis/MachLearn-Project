---
title: "Weight Lifting Exercise Prediction"
subtitle: "Practicle Machine Learning Course Project"
author: "Brian Gulbis"
date: "August 16, 2015"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
---

```{r echo=FALSE}
library(plyr)
library(dplyr)
library(lubridate)
library(caret)
```


```{r echo=FALSE, warning=FALSE}
training <- read.csv("pml-training.csv", stringsAsFactors = FALSE) %>%
    mutate(cvtd_timestamp = dmy_hm(cvtd_timestamp),
           user_name = factor(user_name),
           new_window = factor(new_window),
           classe = factor(classe)) %>%
    rename(max_pitch_belt = max_picth_belt,
           kurtosis_pitch_belt = kurtosis_picth_belt,
           kurtosis_pitch_arm = kurtosis_picth_arm,
           max_pitch_arm = max_picth_arm,
           max_pitch_dumbbell = max_picth_dumbbell,
           kurtosis_pitch_forearm = kurtosis_picth_forearm,
           max_pitch_forearm = max_picth_forearm) %>%
    mutate_each(funs(as.numeric), roll_belt:magnet_forearm_z)

testing <- read.csv("pml-testing.csv", stringsAsFactors = FALSE) %>%
    mutate(cvtd_timestamp = dmy_hm(cvtd_timestamp),
           user_name = factor(user_name),
           new_window = factor(new_window)) %>%
    rename(max_pitch_belt = max_picth_belt,
           kurtosis_pitch_belt = kurtosis_picth_belt,
           kurtosis_pitch_arm = kurtosis_picth_arm,
           max_pitch_arm = max_picth_arm,
           max_pitch_dumbbell = max_picth_dumbbell,
           kurtosis_pitch_forearm = kurtosis_picth_forearm,
           max_pitch_forearm = max_picth_forearm) %>%
    mutate_each(funs(as.numeric), roll_belt:magnet_forearm_z)
    
```

```{r}
library(doParallel)
if (Sys.getenv("PROCESSOR_ARCHITECTURE") != "x86") {
    registerDoParallel()
}
```


## Create Validation Partition

```{r}
inValid <- createDataPartition(y=training$classe, p=0.75, list=FALSE)
train.set <- training[inValid,]
valid.set <- training[-inValid,]
```

## Exploratory Analysis

```{r}
summary(training)

featurePlot(x=training[,c("avg_roll_belt","var_roll_belt")], y=training$classe, plot="pairs")

qplot(var_roll_belt, classe, data=training)

```

Potential features to include (from authors)

* Belt
  * mean and variance of roll: avg\_roll\_belt, var\_roll\_belt
  * maximum, range, and variance of accelerometer: var\_total\_accel\_belt (?)
  * variance of gyro
  * variance of magnetometer
* Arm
  * variance of accelerometer
  * maximum and minimum of magnetometer
* Dumbbell
  * maximum of accelerometer
  * variance of gyro
  * maximum and minimum of magnetometer
* Forearm
  * sum of pitch: pitch\_forearm
  * maximum and minimum of gyro

```{r}


```


Near Zero Frequency

```{r}
#folds <- createFolds(y=training$classe)

#near.zero <- nearZeroVar(training, saveMetrics = TRUE)
trainFtr <- select(train.set, -(X:new_window), -classe)
nzv <- nearZeroVar(trainFtr)
fltr.nz <- trainFtr[, -nzv]
```

Correlated Predictors

```{r}
corPred <- cor(fltr.nz, use="complete.obs")
highCor <- findCorrelation(corPred, cutoff = 0.8)
fltr.cor <- fltr.nz[, -highCor]
#highCor <- abs(cor.pred[upper.tri(cor.pred)]) > 0.9
#sum(highCor)
#summary(cor.pred[upper.tri(cor.pred)])

```

Center and Scale; Impute

```{r}
set.seed(1235)
#preProc <- preProcess(fltr.cor, method=c("center", "scale"))
preProc <- preProcess(fltr.cor, method=c("knnImpute"))
train.preproc <- predict(preProc, fltr.cor)
train.preproc$classe <- train.set$classe
```

Prep Training Validation Set

```{r}
validate <- select(valid.set, -(X:new_window), -classe)
validate <- validate[, -nzv]
validate <- validate[, -highCor]
validate <- predict(preProc, validate)
validate$classe <- valid.set$classe
```

Prep Final Test Set

```{r}
test <- select(testing, -(X:new_window))
test <- test[, -nzv]
test <- test[, -highCor]
test <- predict(preProc, test)
#test$classe <- valid.set$classe
```


```{r}
myseeds <- list(c(123,234,345), c(456,567,678), c(789,890,901), c(987,876,765), c(654,543,432), c(321,210,109), c(135,246,357), c(468,579,680), c(791,802,913), c(975,864,753), 54321) 
```

```{r}
library(rpart)
trCtrl <- trainControl(method="repeatedcv", seeds=myseeds)
#modelGLM <- train(classe ~ ., method="glm", data=train.preproc, trControl=trCtrl)
modelCART <- train(classe ~ ., method="rpart", data=train.preproc, trControl=trCtrl)

```

Random Forest

```{r cache=TRUE}
#myseeds <- list() length 11, 10 integer vectors of size 3
trCtrl <- trainControl(method="repeatedcv", seeds=myseeds)

modelRF.save <- "modelRF.Rds"

if (file.exists(modelRF.save)) {
    # Read the model in and assign it to a variable.
    library(randomForest)
    modelRF <- readRDS(modelRF.save)
} else {
    # Otherwise, run the training.
    modelRF <- train(classe ~ ., method="rf", data=train.preproc, trControl=trCtrl)
    saveRDS(modelRF, modelRF.save)
}

```

Boosting

```{r}
modelGBM.save <- "modelGBM.Rds"

if (file.exists(modelGBM.save)) {
    # Read the model in and assign it to a variable.
    library(gbm)
    modelGBM <- readRDS(modelGBM.save)
} else {
    # Otherwise, run the training.
    modelGBM <- train(classe ~ ., method="gbm", data=train.preproc, verbose=FALSE, trControl=trCtrl)
    saveRDS(modelGBM, modelGBM.save)
}

```

LDA

```{r}
modelLDA.save <- "modelLDA.Rds"

if (file.exists(modelLDA.save)) {
    # Read the model in and assign it to a variable.
    #library(gbm)
    modelLDA <- readRDS(modelLDA.save)
} else {
    # Otherwise, run the training.
    modelLDA <- train(classe ~ ., method="lda", data=train.preproc, trControl=trCtrl)
    saveRDS(modelLDA, modelLDA.save)
}
```

Prediction

```{r}
predRF <- predict(modelRF, validate)
cmRF <- confusionMatrix(predRF, validate$classe)

predCART <- -predict(modelCART, validate)
cmCART <- confusionMatrix(predCART, validate$classe)
```



```{r warning=FALSE}
#near.zero <- nearZeroVar(training, saveMetrics = TRUE)
#nz <- training[,near.zero$zeroVar == FALSE]
#preProc <- preProcess(nz[,8:150], method="pca", pcaComp=5)
#trainPCA <- predict(preProc, nz[,8:150])
#modelFit <- train(training$classe ~ ., method="glm", data=trainPCA)
```

